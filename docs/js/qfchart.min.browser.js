
/* 
 * Copyright (C) 2025 Alaa-eddine KADDOURI
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(B,_){typeof exports=="object"&&typeof module<"u"?_(exports,require("echarts")):typeof define=="function"&&define.amd?define(["exports","echarts"],_):(B=typeof globalThis<"u"?globalThis:B||self,_(B.QFChart={},B.echarts))})(this,function(B,_){"use strict";function ft(a){var e=Object.create(null);return a&&Object.keys(a).forEach(function(t){if(t!=="default"){var i=Object.getOwnPropertyDescriptor(a,t);Object.defineProperty(e,t,i.get?i:{enumerable:!0,get:function(){return a[t]}})}}),e.default=a,Object.freeze(e)}var E=ft(_),yt=Object.defineProperty,xt=(a,e,t)=>e in a?yt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,U=(a,e,t)=>(xt(a,typeof e!="symbol"?e+"":e,t),t);class mt{constructor(e,t,i,s={}){U(this,"id"),U(this,"plots"),U(this,"paneIndex"),U(this,"height"),U(this,"collapsed"),U(this,"titleColor"),U(this,"controls"),this.id=e,this.plots=t,this.paneIndex=i,this.height=s.height,this.collapsed=s.collapsed||!1,this.titleColor=s.titleColor,this.controls=s.controls}toggleCollapse(){this.collapsed=!this.collapsed}isVisible(){return!this.collapsed}updateData(e){Object.keys(e).forEach(t=>{if(!this.plots[t])this.plots[t]=e[t];else{const i=this.plots[t],s=e[t];s.options&&(i.options={...i.options,...s.options});const n=new Map;i.data.forEach(o=>{n.set(o.time,o)}),s.data.forEach(o=>{n.set(o.time,o)}),i.data=Array.from(n.values()).sort((o,r)=>o.time-r.time)}})}}class ut{static calculate(e,t,i,s=!1,n=null){let o=0;e>0&&(o=1/e*100);const r=Array.from(t.values()).map(g=>g.paneIndex).filter(g=>g>0).sort((g,w)=>g-w).filter((g,w,z)=>z.indexOf(g)===w),p=r.length>0,u=i.dataZoom?.visible??!0,v=i.dataZoom?.position??"top",f=i.dataZoom?.height??6,m=i.dataZoom?.start??0,d=i.dataZoom?.end??100;let x=8,S=92,I=-1;if(n)if(n==="main")I=0;else{const g=t.get(n);g&&(I=g.paneIndex)}if(I!==-1){const g=[],w=[],z=[],O=[],W=i.dataZoom?.start??50,P=i.dataZoom?.end??100;O.push({type:"inside",xAxisIndex:"all",start:W,end:P});const M=p?Math.max(...r):0,Z=[];for(let N=0;N<=M;N++){const A=N===I;if(g.push({left:"10%",right:"10%",top:A?"5%":"0%",height:A?"90%":"0%",show:A,containLabel:!1}),w.push({type:"category",gridIndex:N,data:[],show:A,axisLabel:{show:A,color:"#94a3b8",fontFamily:i.fontFamily},axisLine:{show:A,lineStyle:{color:"#334155"}},splitLine:{show:A,lineStyle:{color:"#334155",opacity:.5}}}),z.push({position:"right",gridIndex:N,show:A,scale:!0,axisLabel:{show:A,color:"#94a3b8",fontFamily:i.fontFamily},splitLine:{show:A,lineStyle:{color:"#334155",opacity:.5}}}),N>0){const j=Array.from(t.values()).find(H=>H.paneIndex===N);j&&Z.push({index:N,height:A?90:0,top:A?5:0,isCollapsed:!1,indicatorId:j.id,titleColor:j.titleColor,controls:j.controls})}}return{grid:g,xAxis:w,yAxis:z,dataZoom:O,paneLayout:Z,mainPaneHeight:I===0?90:0,mainPaneTop:I===0?5:0,pixelToPercent:o}}u?v==="top"?(x=f+4,S=95):(S=100-f-2,x=8):(x=5,S=95);let L=5;e>0&&(L=20/e*100);let D=75,y=[];if(p){const g=r.map(P=>{const M=Array.from(t.values()).find(Z=>Z.paneIndex===P);return{index:P,requestedHeight:M?.height,isCollapsed:M?.collapsed??!1,indicatorId:M?.id,titleColor:M?.titleColor,controls:M?.controls}}).map(P=>({...P,height:P.isCollapsed?3:P.requestedHeight!==void 0?P.requestedHeight:15})),w=g.reduce((P,M)=>P+M.height,0),z=g.length*L,O=w+z;D=S-x-O,s?D=3:D<20&&(D=Math.max(D,10));let W=x+D+L;y=g.map(P=>{const M={index:P.index,height:P.height,top:W,isCollapsed:P.isCollapsed,indicatorId:P.indicatorId,titleColor:P.titleColor,controls:P.controls};return W+=P.height+L,M})}else D=S-x,s&&(D=3);const c=[];c.push({left:"10%",right:"10%",top:x+"%",height:D+"%",containLabel:!1}),y.forEach(g=>{c.push({left:"10%",right:"10%",top:g.top+"%",height:g.height+"%",containLabel:!1})});const l=[0,...y.map((g,w)=>w+1)],b=[],h=y.length===0;b.push({type:"category",data:[],gridIndex:0,scale:!0,axisLine:{onZero:!1,show:!s,lineStyle:{color:"#334155"}},splitLine:{show:!s,lineStyle:{color:"#334155",opacity:.5}},axisLabel:{show:!s,color:"#94a3b8",fontFamily:i.fontFamily||"sans-serif"},axisTick:{show:!s},axisPointer:{label:{show:h,fontSize:11,backgroundColor:"#475569"}}}),y.forEach((g,w)=>{const z=w===y.length-1;b.push({type:"category",gridIndex:w+1,data:[],axisLabel:{show:!1},axisLine:{show:!g.isCollapsed,lineStyle:{color:"#334155"}},axisTick:{show:!1},splitLine:{show:!1},axisPointer:{label:{show:z,fontSize:11,backgroundColor:"#475569"}}})});const C=[];C.push({position:"right",scale:!0,gridIndex:0,splitLine:{show:!s,lineStyle:{color:"#334155",opacity:.5}},axisLine:{show:!s,lineStyle:{color:"#334155"}},axisLabel:{show:!s,color:"#94a3b8",fontFamily:i.fontFamily||"sans-serif"}}),y.forEach((g,w)=>{C.push({position:"right",scale:!0,gridIndex:w+1,splitLine:{show:!g.isCollapsed,lineStyle:{color:"#334155",opacity:.3}},axisLabel:{show:!g.isCollapsed,color:"#94a3b8",fontFamily:i.fontFamily||"sans-serif",fontSize:10},axisLine:{show:!g.isCollapsed,lineStyle:{color:"#334155"}}})});const T=[];return u&&(T.push({type:"inside",xAxisIndex:l,start:m,end:d}),v==="top"?T.push({type:"slider",xAxisIndex:l,top:"1%",height:f+"%",start:m,end:d,borderColor:"#334155",textStyle:{color:"#cbd5e1"},brushSelect:!1}):T.push({type:"slider",xAxisIndex:l,bottom:"1%",height:f+"%",start:m,end:d,borderColor:"#334155",textStyle:{color:"#cbd5e1"},brushSelect:!1})),{grid:c,xAxis:b,yAxis:C,dataZoom:T,paneLayout:y,mainPaneHeight:D,mainPaneTop:x,pixelToPercent:o}}static calculateMaximized(e,t,i){return{grid:[],xAxis:[],yAxis:[],dataZoom:[],paneLayout:[],mainPaneHeight:0,mainPaneTop:0,pixelToPercent:0}}}const ot=new Map;function bt(a,e="#00da3c",t="64px"){if(typeof document>"u")return"";const i=`${a}-${e}-${t}`;if(ot.has(i))return ot.get(i);const s=document.createElement("canvas"),n=s.getContext("2d");if(s.width=32,s.height=32,n){n.font="bold "+t+" Arial",n.fillStyle=e,n.textAlign="center",n.textBaseline="middle",n.fillText(a,16,16);const o=s.toDataURL("image/png");return ot.set(i,o),o}return""}class q{static buildCandlestickSeries(e,t,i){const s=t.upColor||"#00da3c",n=t.downColor||"#ec0000",o=e.map(r=>[r.open,r.close,r.low,r.high]);if(i&&i>o.length){const r=i-o.length;for(let p=0;p<r;p++)o.push(null)}return{type:"candlestick",name:t.title||"Market",data:o,itemStyle:{color:s,color0:n,borderColor:s,borderColor0:n},xAxisIndex:0,yAxisIndex:0,z:5}}static getShapeSymbol(e){switch(e){case"arrowdown":return"path://M12 24l-12-12h8v-12h8v12h8z";case"arrowup":return"path://M12 0l12 12h-8v12h-8v-12h-8z";case"circle":return"circle";case"cross":return"path://M11 2h2v9h9v2h-9v9h-2v-9h-9v-2h9z";case"diamond":return"diamond";case"flag":return"path://M6 2v20h2v-8h12l-2-6 2-6h-12z";case"labeldown":return"path://M4 2h16a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-6l-2 4l-2 -4h-6a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2z";case"labelup":return"path://M12 2l2 4h6a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-16a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h6z";case"square":return"rect";case"triangledown":return"path://M12 21l-10-18h20z";case"triangleup":return"triangle";case"xcross":return"path://M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z";default:return"circle"}}static getShapeRotation(e){return 0}static getShapeSize(e,t,i){if(t!==void 0&&i!==void 0)return[t,i];let s;switch(e){case"tiny":s=8;break;case"small":s=12;break;case"normal":case"auto":s=16;break;case"large":s=24;break;case"huge":s=32;break;default:s=16}return t!==void 0?[t,t]:i!==void 0?[i,i]:s}static getLabelConfig(e,t){switch(t){case"abovebar":return{position:"top",distance:5};case"belowbar":return{position:"bottom",distance:5};case"top":return{position:"bottom",distance:5};case"bottom":return{position:"top",distance:5};case"absolute":default:return e==="labelup"||e==="labeldown"?{position:"inside",distance:0}:{position:"top",distance:5}}}static buildIndicatorSeries(e,t,i,s,n=0,o){const r=[];return e.forEach((p,u)=>{if(p.collapsed)return;let v=0,f=0;if(p.paneIndex>0){const m=i.findIndex(d=>d.index===p.paneIndex);m!==-1&&(v=m+1,f=m+1)}Object.keys(p.plots).forEach(m=>{const d=p.plots[m],x=`${u}::${m}`,S=new Array(s).fill(null),I=new Array(s).fill(null),L=new Array(s).fill(null);switch(d.data.forEach(D=>{const y=t.get(D.time);if(y!==void 0){const c=D.options?.offset??d.options.offset??0,l=y+n+c;if(l>=0&&l<s){let b=D.value;const h=D.options?.color;(h===null||h==="na"||h==="NaN"||typeof h=="number"&&isNaN(h))&&(b=null),S[l]=b,I[l]=h||d.options.color,L[l]=D.options||{}}}}),d.options.style){case"histogram":case"columns":r.push({name:x,type:"bar",xAxisIndex:v,yAxisIndex:f,data:S.map((c,l)=>({value:c,itemStyle:I[l]?{color:I[l]}:void 0})),itemStyle:{color:d.options.color}});break;case"circles":case"cross":const D=S.map((c,l)=>{if(c===null)return null;const b=I[l]||d.options.color,h={value:[l,c],itemStyle:{color:b}};return d.options.style==="cross"?(h.symbol=`image://${bt("+",b,"24px")}`,h.symbolSize=16):(h.symbol="circle",h.symbolSize=6),h}).filter(c=>c!==null);r.push({name:x,type:"scatter",xAxisIndex:v,yAxisIndex:f,data:D});break;case"shape":const y=S.map((c,l)=>{const b=L[l]||{},h=d.options,C=b.location||h.location||"absolute";if(C!=="absolute"&&!c||c==null)return null;const T=b.color||h.color||"blue",g=b.shape||h.shape||"circle",w=b.size||h.size||"normal",z=b.text||h.text,O=b.textcolor||h.textcolor||"white",W=b.width||h.width,P=b.height||h.height;let M=c,Z=[0,0];C==="abovebar"?(o&&o[l]&&(M=o[l].high),Z=[0,"-150%"]):C==="belowbar"?(o&&o[l]&&(M=o[l].low),Z=[0,"150%"]):C==="top"?(M=c,Z=[0,0]):C==="bottom"&&(M=c,Z=[0,0]);const N=q.getShapeSymbol(g),A=q.getShapeSize(w,W,P),j=q.getShapeRotation(g);let H=A;g.includes("label")&&(Array.isArray(A)?H=[A[0]*2.5,A[1]*2.5]:H=A*2.5);const R=q.getLabelConfig(g,C);return{value:[l,M],symbol:N,symbolSize:H,symbolRotate:j,symbolOffset:Z,itemStyle:{color:T},label:{show:!!z,position:R.position,distance:R.distance,formatter:z,color:O,fontSize:10,fontWeight:"bold"}}}).filter(c=>c!==null);r.push({name:x,type:"scatter",xAxisIndex:v,yAxisIndex:f,data:y});break;case"background":r.push({name:x,type:"custom",xAxisIndex:v,yAxisIndex:f,z:-10,renderItem:(c,l)=>{const b=l.value(0);if(isNaN(b))return;const h=l.coord([b,0]),C=l.size([1,0])[0],T=c.coordSys,g=h[0]-C/2,w=I[c.dataIndex],z=l.value(1);if(!(!w||!z))return{type:"rect",shape:{x:g,y:T.y,width:C,height:T.height},style:{fill:w,opacity:.3},silent:!0}},data:S.map((c,l)=>[l,c])});break;case"step":r.push({name:x,type:"custom",xAxisIndex:v,yAxisIndex:f,renderItem:(c,l)=>{const b=l.value(0),h=l.value(1);if(isNaN(h)||h===null)return;const C=l.coord([b,h]),T=l.size([1,0])[0];return{type:"line",shape:{x1:C[0]-T/2,y1:C[1],x2:C[0]+T/2,y2:C[1]},style:{stroke:I[c.dataIndex]||d.options.color,lineWidth:d.options.linewidth||1},silent:!0}},data:S.map((c,l)=>[l,c])});break;case"line":default:r.push({name:x,type:"custom",xAxisIndex:v,yAxisIndex:f,renderItem:(c,l)=>{const b=c.dataIndex;if(b===0)return;const h=l.value(1),C=l.value(2);if(h===null||isNaN(h)||C===null||isNaN(C))return;const T=l.coord([b-1,C]),g=l.coord([b,h]);return{type:"line",shape:{x1:T[0],y1:T[1],x2:g[0],y2:g[1]},style:{stroke:I[b]||d.options.color,lineWidth:d.options.linewidth||1},silent:!0}},data:S.map((c,l)=>[l,c,l>0?S[l-1]:null])});break}})}),r}}class vt{static build(e,t,i,s=!1,n=null){const o=[],r=e.pixelToPercent,p=e.mainPaneTop;if(!n||n==="main"){const u=10*r;if(o.push({type:"text",left:"8.5%",top:p+u+"%",z:10,style:{text:t.title||"Market",fill:t.titleColor||"#fff",font:`bold 16px ${t.fontFamily||"sans-serif"}`,textVerticalAlign:"top"}}),t.watermark!==!1){const f=e.mainPaneTop+e.mainPaneHeight;o.push({type:"text",right:"11%",top:f-3+"%",z:10,style:{text:"QFChart",fill:t.fontColor||"#cbd5e1",font:"bold 16px sans-serif",opacity:.1},cursor:"pointer",onclick:()=>{window.open("https://quantforge.org","_blank")}})}const v=[];if(t.controls?.collapse&&v.push({type:"group",children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>i("main","collapse")},{type:"text",style:{text:s?"+":"\u2212",fill:"#cbd5e1",font:`bold 14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]}),t.controls?.maximize){const f=n==="main",m=t.controls?.collapse?25:0;v.push({type:"group",x:m,children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>i("main","maximize")},{type:"text",style:{text:f?"\u2750":"\u25A1",fill:"#cbd5e1",font:`14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]})}if(t.controls?.fullscreen){let f=0;t.controls?.collapse&&(f+=25),t.controls?.maximize&&(f+=25),v.push({type:"group",x:f,children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>i("main","fullscreen")},{type:"text",style:{text:"\u26F6",fill:"#cbd5e1",font:`14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]})}v.length>0&&o.push({type:"group",right:"10.5%",top:p+"%",children:v})}return e.paneLayout.forEach(u=>{if(n&&u.indicatorId!==n)return;o.push({type:"text",left:"8.5%",top:u.top+10*r+"%",z:10,style:{text:u.indicatorId||"",fill:u.titleColor||"#fff",font:`bold 12px ${t.fontFamily||"sans-serif"}`,textVerticalAlign:"top"}});const v=[];if(u.controls?.collapse&&v.push({type:"group",children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>u.indicatorId&&i(u.indicatorId,"collapse")},{type:"text",style:{text:u.isCollapsed?"+":"\u2212",fill:"#cbd5e1",font:`bold 14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]}),u.controls?.maximize){const f=n===u.indicatorId,m=u.controls?.collapse?25:0;v.push({type:"group",x:m,children:[{type:"rect",shape:{width:20,height:20,r:2},style:{fill:"#334155",stroke:"#475569",lineWidth:1},onclick:()=>u.indicatorId&&i(u.indicatorId,"maximize")},{type:"text",style:{text:f?"\u2750":"\u25A1",fill:"#cbd5e1",font:`14px ${t.fontFamily}`,x:10,y:10,textAlign:"center",textVerticalAlign:"middle"},silent:!0}]})}v.length>0&&o.push({type:"group",right:"10.5%",top:u.top+"%",children:v})}),o}}class wt{static format(e,t){if(!e||e.length===0)return"";const i=t.title||"Market",s=t.upColor||"#00da3c",n=t.downColor||"#ec0000",o=t.fontFamily||"sans-serif",r=e[0].axisValue;let p=`<div style="font-weight: bold; margin-bottom: 5px; color: #cbd5e1; font-family: ${o};">${r}</div>`;const u=e.find(f=>f.seriesType==="candlestick"),v=e.filter(f=>f.seriesType!=="candlestick");if(u){const[f,m,d,x,S]=u.value,I=d>=m?s:n;p+=`
            <div style="margin-bottom: 8px; font-family: ${o};">
                <div style="display:flex; justify-content:space-between; color:${I}; font-weight:bold;">
                    <span>${i}</span>
                </div>
                <div style="display: grid; grid-template-columns: auto auto; gap: 2px 15px; font-size: 0.9em; color: #cbd5e1;">
                    <span>Open:</span> <span style="text-align: right; color: ${d>=m?s:n}">${m}</span>
                    <span>High:</span> <span style="text-align: right; color: ${s}">${S}</span>
                    <span>Low:</span> <span style="text-align: right; color: ${n}">${x}</span>
                    <span>Close:</span> <span style="text-align: right; color: ${d>=m?s:n}">${d}</span>
                </div>
            </div>
            `}if(v.length>0){p+='<div style="border-top: 1px solid #334155; margin: 5px 0; padding-top: 5px;"></div>';const f={};v.forEach(m=>{const d=m.seriesName.split("::"),x=d.length>1?d[0]:"Unknown",S=d.length>1?d[1]:m.seriesName;f[x]||(f[x]=[]),f[x].push({...m,displayName:S})}),Object.keys(f).forEach(m=>{p+=`
            <div style="margin-top: 8px; font-family: ${o};">
                <div style="font-weight:bold; color: #fff; margin-bottom: 2px;">${m}</div>
            `,f[m].forEach(d=>{let x=d.value;if(Array.isArray(x)&&(x=x[1]),x==null)return;const S=typeof x=="number"?x.toLocaleString(void 0,{maximumFractionDigits:4}):x;p+=`
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; padding-left: 8px;">
                    <div>${d.marker} <span style="color: #cbd5e1;">${d.displayName}</span></div>
                    <div style="font-size: 10px; color: #fff;padding-left:10px;">${S}</div>
                </div>`}),p+="</div>"})}return p}}var Ct=Object.defineProperty,St=(a,e,t)=>e in a?Ct(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,J=(a,e,t)=>(St(a,typeof e!="symbol"?e+"":e,t),t);class kt{constructor(e,t){J(this,"plugins",new Map),J(this,"activePluginId",null),J(this,"context"),J(this,"toolbarContainer"),J(this,"tooltipElement",null),J(this,"hideTimeout",null),this.context=e,this.toolbarContainer=t,this.createTooltip(),this.renderToolbar()}createTooltip(){this.tooltipElement=document.createElement("div"),Object.assign(this.tooltipElement.style,{position:"fixed",display:"none",backgroundColor:"#1e293b",color:"#e2e8f0",padding:"6px 10px",borderRadius:"6px",fontSize:"13px",lineHeight:"1.4",fontWeight:"500",border:"1px solid #334155",zIndex:"9999",pointerEvents:"none",whiteSpace:"nowrap",boxShadow:"0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15)",fontFamily:this.context.getOptions().fontFamily||"sans-serif",transition:"opacity 0.15s ease-in-out, transform 0.15s ease-in-out",opacity:"0",transform:"translateX(-5px)"}),document.body.appendChild(this.tooltipElement)}destroy(){this.tooltipElement&&this.tooltipElement.parentNode&&this.tooltipElement.parentNode.removeChild(this.tooltipElement),this.tooltipElement=null}showTooltip(e,t){if(!this.tooltipElement)return;this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null);const i=e.getBoundingClientRect();this.tooltipElement.textContent=t,this.tooltipElement.style.display="block";const s=this.tooltipElement.getBoundingClientRect(),n=i.top+(i.height-s.height)/2,o=i.right+10;this.tooltipElement.style.top=`${n}px`,this.tooltipElement.style.left=`${o}px`,requestAnimationFrame(()=>{this.tooltipElement&&(this.tooltipElement.style.opacity="1",this.tooltipElement.style.transform="translateX(0)")})}hideTooltip(){this.tooltipElement&&(this.tooltipElement.style.opacity="0",this.tooltipElement.style.transform="translateX(-5px)",this.hideTimeout&&clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>{this.tooltipElement&&(this.tooltipElement.style.display="none"),this.hideTimeout=null},150))}register(e){if(this.plugins.has(e.id)){console.warn(`Plugin with id ${e.id} is already registered.`);return}this.plugins.set(e.id,e),e.init(this.context),this.addButton(e)}unregister(e){const t=this.plugins.get(e);t&&(this.activePluginId===e&&this.deactivatePlugin(),t.destroy?.(),this.plugins.delete(e),this.removeButton(e))}activatePlugin(e){if(this.activePluginId===e){this.deactivatePlugin();return}this.activePluginId&&this.deactivatePlugin();const t=this.plugins.get(e);t&&(this.activePluginId=e,this.setButtonActive(e,!0),t.activate?.())}deactivatePlugin(){this.activePluginId&&(this.plugins.get(this.activePluginId)?.deactivate?.(),this.setButtonActive(this.activePluginId,!1),this.activePluginId=null)}renderToolbar(){this.toolbarContainer.innerHTML="",this.toolbarContainer.style.display="flex",this.toolbarContainer.style.flexDirection="column",this.toolbarContainer.style.width="40px",this.toolbarContainer.style.backgroundColor=this.context.getOptions().backgroundColor||"#1e293b",this.toolbarContainer.style.borderRight="1px solid #334155",this.toolbarContainer.style.padding="5px",this.toolbarContainer.style.boxSizing="border-box",this.toolbarContainer.style.gap="5px",this.toolbarContainer.style.flexShrink="0"}addButton(e){const t=document.createElement("button");t.id=`qfchart-plugin-btn-${e.id}`,t.style.width="30px",t.style.height="30px",t.style.padding="4px",t.style.border="1px solid transparent",t.style.borderRadius="4px",t.style.backgroundColor="transparent",t.style.cursor="pointer",t.style.color=this.context.getOptions().fontColor||"#cbd5e1",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",e.icon?t.innerHTML=e.icon:t.innerText=(e.name||e.id).substring(0,2).toUpperCase(),t.addEventListener("mouseenter",()=>{this.activePluginId!==e.id&&(t.style.backgroundColor="rgba(255, 255, 255, 0.1)"),this.showTooltip(t,e.name||e.id)}),t.addEventListener("mouseleave",()=>{this.activePluginId!==e.id&&(t.style.backgroundColor="transparent"),this.hideTooltip()}),t.onclick=()=>this.activatePlugin(e.id),this.toolbarContainer.appendChild(t)}removeButton(e){const t=this.toolbarContainer.querySelector(`#qfchart-plugin-btn-${e}`);t&&t.remove()}setButtonActive(e,t){const i=this.toolbarContainer.querySelector(`#qfchart-plugin-btn-${e}`);i&&(t?(i.style.backgroundColor="#2563eb",i.style.color="#ffffff"):(i.style.backgroundColor="transparent",i.style.color=this.context.getOptions().fontColor||"#cbd5e1"))}}var It=Object.defineProperty,Pt=(a,e,t)=>e in a?It(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,$=(a,e,t)=>(Pt(a,typeof e!="symbol"?e+"":e,t),t);class Mt{constructor(e){$(this,"context"),$(this,"isEditing",!1),$(this,"currentDrawing",null),$(this,"editingPointIndex",null),$(this,"zr"),$(this,"editGroup",null),$(this,"editLine",null),$(this,"editStartPoint",null),$(this,"editEndPoint",null),$(this,"isMovingShape",!1),$(this,"dragStart",null),$(this,"initialPixelPoints",[]),$(this,"onDrawingMouseDown",t=>{if(this.isEditing)return;const i=this.context.getDrawing(t.id);i&&(this.isEditing=!0,this.isMovingShape=!0,this.currentDrawing=JSON.parse(JSON.stringify(i)),this.dragStart={x:t.x,y:t.y},this.initialPixelPoints=i.points.map(s=>{const n=this.context.coordinateConversion.dataToPixel(s);return n?{x:n.x,y:n.y}:{x:0,y:0}}),this.context.lockChart(),this.createEditGraphic(),this.zr.on("mousemove",this.onMouseMove),this.zr.on("mouseup",this.onMouseUp))}),$(this,"onPointMouseDown",t=>{if(this.isEditing)return;const i=this.context.getDrawing(t.id);i&&(this.isEditing=!0,this.currentDrawing=JSON.parse(JSON.stringify(i)),this.editingPointIndex=t.pointIndex,this.context.lockChart(),this.createEditGraphic(),this.zr.on("mousemove",this.onMouseMove),this.zr.on("mouseup",this.onMouseUp))}),$(this,"onMouseMove",t=>{if(!this.isEditing||!this.currentDrawing)return;const i=t.offsetX,s=t.offsetY;if(this.isMovingShape&&this.dragStart){const n=i-this.dragStart.x,o=s-this.dragStart.y,r={x:this.initialPixelPoints[0].x+n,y:this.initialPixelPoints[0].y+o},p={x:this.initialPixelPoints[1].x+n,y:this.initialPixelPoints[1].y+o};this.editLine.setShape({x1:r.x,y1:r.y,x2:p.x,y2:p.y}),this.editStartPoint.setShape({cx:r.x,cy:r.y}),this.editEndPoint.setShape({cx:p.x,cy:p.y})}else this.editingPointIndex!==null&&(this.editingPointIndex===0?(this.editLine.setShape({x1:i,y1:s}),this.editStartPoint.setShape({cx:i,cy:s})):(this.editLine.setShape({x2:i,y2:s}),this.editEndPoint.setShape({cx:i,cy:s})))}),$(this,"onMouseUp",t=>{this.isEditing&&this.finishEditing(t.offsetX,t.offsetY)}),this.context=e,this.zr=this.context.getChart().getZr(),this.bindEvents()}bindEvents(){this.context.events.on("drawing:point:mousedown",this.onPointMouseDown),this.context.events.on("drawing:mousedown",this.onDrawingMouseDown)}createEditGraphic(){if(!this.currentDrawing)return;this.editGroup=new E.graphic.Group;const e=this.currentDrawing.points[0],t=this.currentDrawing.points[1],i=this.context.coordinateConversion.dataToPixel(e),s=this.context.coordinateConversion.dataToPixel(t);!i||!s||(this.editLine=new E.graphic.Line({shape:{x1:i.x,y1:i.y,x2:s.x,y2:s.y},style:{stroke:this.currentDrawing.style?.color||"#3b82f6",lineWidth:this.currentDrawing.style?.lineWidth||2,lineDash:[4,4]},silent:!0}),this.editStartPoint=new E.graphic.Circle({shape:{cx:i.x,cy:i.y,r:5},style:{fill:"#fff",stroke:"#3b82f6",lineWidth:2},z:1e3}),this.editEndPoint=new E.graphic.Circle({shape:{cx:s.x,cy:s.y,r:5},style:{fill:"#fff",stroke:"#3b82f6",lineWidth:2},z:1e3}),this.editGroup.add(this.editLine),this.editGroup.add(this.editStartPoint),this.editGroup.add(this.editEndPoint),this.zr.add(this.editGroup))}finishEditing(e,t){if(this.currentDrawing){if(this.isMovingShape&&this.dragStart){const i=e-this.dragStart.x,s=t-this.dragStart.y,n=this.initialPixelPoints.map((o,r)=>{const p=o.x+i,u=o.y+s;return this.context.coordinateConversion.pixelToData({x:p,y:u})});n.every(o=>o!==null)&&n[0]&&n[1]&&(this.currentDrawing.points[0]=n[0],this.currentDrawing.points[1]=n[1],n[0].paneIndex!==void 0&&(this.currentDrawing.paneIndex=n[0].paneIndex),this.context.updateDrawing(this.currentDrawing))}else if(this.editingPointIndex!==null){const i=this.context.coordinateConversion.pixelToData({x:e,y:t});i&&(this.currentDrawing.points[this.editingPointIndex]=i,this.editingPointIndex===0&&i.paneIndex!==void 0&&(this.currentDrawing.paneIndex=i.paneIndex),this.context.updateDrawing(this.currentDrawing))}this.isEditing=!1,this.isMovingShape=!1,this.dragStart=null,this.initialPixelPoints=[],this.currentDrawing=null,this.editingPointIndex=null,this.editGroup&&(this.zr.remove(this.editGroup),this.editGroup=null),this.zr.off("mousemove",this.onMouseMove),this.zr.off("mouseup",this.onMouseUp),this.context.unlockChart()}}}var Dt=Object.defineProperty,zt=(a,e,t)=>e in a?Dt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,Et=(a,e,t)=>(zt(a,typeof e!="symbol"?e+"":e,t),t);class Tt{constructor(){Et(this,"handlers",new Map)}on(e,t){this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t)}off(e,t){const i=this.handlers.get(e);i&&i.delete(t)}emit(e,t){const i=this.handlers.get(e);i&&i.forEach(s=>{try{s(t)}catch(n){console.error(`Error in EventBus handler for ${e}:`,n)}})}clear(){this.handlers.clear()}}var At=Object.defineProperty,Lt=(a,e,t)=>e in a?At(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,k=(a,e,t)=>(Lt(a,typeof e!="symbol"?e+"":e,t),t);class Zt{constructor(e,t={}){k(this,"chart"),k(this,"options"),k(this,"marketData",[]),k(this,"indicators",new Map),k(this,"timeToIndex",new Map),k(this,"pluginManager"),k(this,"drawingEditor"),k(this,"events",new Tt),k(this,"isMainCollapsed",!1),k(this,"maximizedPaneId",null),k(this,"selectedDrawingId",null),k(this,"drawings",[]),k(this,"coordinateConversion",{pixelToData:n=>{const o=this.chart.getOption();if(!o||!o.grid)return null;const r=o.grid.length;for(let p=0;p<r;p++)if(this.chart.containPixel({gridIndex:p},[n.x,n.y])){this.chart.convertFromPixel({seriesIndex:p},[n.x,n.y]);const u=this.chart.convertFromPixel({gridIndex:p},[n.x,n.y]);if(u)return{timeIndex:Math.round(u[0]),value:u[1],paneIndex:p}}return null},dataToPixel:n=>{const o=n.paneIndex||0,r=this.chart.convertToPixel({gridIndex:o},[n.timeIndex,n.value]);return r?{x:r[0],y:r[1]}:null}}),k(this,"upColor","#00da3c"),k(this,"downColor","#ec0000"),k(this,"defaultPadding",0),k(this,"padding"),k(this,"dataIndexOffset",0),k(this,"rootContainer"),k(this,"layoutContainer"),k(this,"toolbarContainer"),k(this,"leftSidebar"),k(this,"rightSidebar"),k(this,"chartContainer"),k(this,"onKeyDown",n=>{(n.key==="Delete"||n.key==="Backspace")&&this.selectedDrawingId&&(this.removeDrawing(this.selectedDrawingId),this.selectedDrawingId=null,this.render())}),k(this,"onFullscreenChange",()=>{this.render()}),k(this,"isLocked",!1),k(this,"lockedState",null),this.rootContainer=e,this.options={title:"Market",height:"600px",backgroundColor:"#1e293b",upColor:"#00da3c",downColor:"#ec0000",fontColor:"#cbd5e1",fontFamily:"sans-serif",padding:.01,dataZoom:{visible:!0,position:"top",height:6},layout:{mainPaneHeight:"50%",gap:13},watermark:!0,...t},this.options.upColor&&(this.upColor=this.options.upColor),this.options.downColor&&(this.downColor=this.options.downColor),this.padding=this.options.padding!==void 0?this.options.padding:this.defaultPadding,this.options.height&&(typeof this.options.height=="number"?this.rootContainer.style.height=`${this.options.height}px`:this.rootContainer.style.height=this.options.height),this.rootContainer.innerHTML="",this.layoutContainer=document.createElement("div"),this.layoutContainer.style.display="flex",this.layoutContainer.style.width="100%",this.layoutContainer.style.height="100%",this.layoutContainer.style.overflow="hidden",this.rootContainer.appendChild(this.layoutContainer),this.leftSidebar=document.createElement("div"),this.leftSidebar.style.display="none",this.leftSidebar.style.width="250px",this.leftSidebar.style.flexShrink="0",this.leftSidebar.style.overflowY="auto",this.leftSidebar.style.backgroundColor=this.options.backgroundColor||"#1e293b",this.leftSidebar.style.borderRight="1px solid #334155",this.leftSidebar.style.padding="10px",this.leftSidebar.style.boxSizing="border-box",this.leftSidebar.style.color="#cbd5e1",this.leftSidebar.style.fontSize="12px",this.leftSidebar.style.fontFamily=this.options.fontFamily||"sans-serif",this.layoutContainer.appendChild(this.leftSidebar),this.toolbarContainer=document.createElement("div"),this.layoutContainer.appendChild(this.toolbarContainer),this.chartContainer=document.createElement("div"),this.chartContainer.style.flexGrow="1",this.chartContainer.style.height="100%",this.chartContainer.style.overflow="hidden",this.layoutContainer.appendChild(this.chartContainer),this.rightSidebar=document.createElement("div"),this.rightSidebar.style.display="none",this.rightSidebar.style.width="250px",this.rightSidebar.style.flexShrink="0",this.rightSidebar.style.overflowY="auto",this.rightSidebar.style.backgroundColor=this.options.backgroundColor||"#1e293b",this.rightSidebar.style.borderLeft="1px solid #334155",this.rightSidebar.style.padding="10px",this.rightSidebar.style.boxSizing="border-box",this.rightSidebar.style.color="#cbd5e1",this.rightSidebar.style.fontSize="12px",this.rightSidebar.style.fontFamily=this.options.fontFamily||"sans-serif",this.layoutContainer.appendChild(this.rightSidebar),this.chart=E.init(this.chartContainer),this.pluginManager=new kt(this,this.toolbarContainer),this.drawingEditor=new Mt(this),this.chart.on("dataZoom",n=>this.events.emit("chart:dataZoom",n)),this.chart.on("finished",n=>this.events.emit("chart:updated",n)),this.chart.getZr().on("mousedown",n=>this.events.emit("mouse:down",n)),this.chart.getZr().on("mousemove",n=>this.events.emit("mouse:move",n)),this.chart.getZr().on("mouseup",n=>this.events.emit("mouse:up",n)),this.chart.getZr().on("click",n=>this.events.emit("mouse:click",n));const i=this.chart.getZr(),s=i.setCursorStyle;i.setCursorStyle=function(n){n==="grab"&&(n="crosshair"),s.call(this,n)},this.bindDrawingEvents(),window.addEventListener("resize",this.resize.bind(this)),document.addEventListener("fullscreenchange",this.onFullscreenChange),document.addEventListener("keydown",this.onKeyDown)}bindDrawingEvents(){let e=null;const t=i=>{if(!i||i.componentType!=="series"||!i.seriesName?.startsWith("drawings"))return null;i.seriesIndex;const s=i.seriesName.match(/drawings-pane-(\d+)/);if(!s)return null;const n=parseInt(s[1]),o=this.drawings.filter(p=>(p.paneIndex||0)===n)[i.dataIndex];if(!o)return null;const r=i.event?.target?.name;return{drawing:o,targetName:r,paneIdx:n}};this.chart.on("mouseover",i=>{const s=t(i);if(!s)return;const n=i.event?.target?.parent;if(n){const o=s.drawing.id===this.selectedDrawingId;e&&(clearTimeout(e),e=null),o||n.children().forEach(r=>{r.name&&r.name.startsWith("point")&&r.attr("style",{opacity:1})})}if(s.targetName==="line")this.events.emit("drawing:hover",{id:s.drawing.id,type:s.drawing.type}),this.chart.getZr().setCursorStyle("move");else if(s.targetName?.startsWith("point")){const o=s.targetName==="point-start"?0:1;this.events.emit("drawing:point:hover",{id:s.drawing.id,pointIndex:o}),this.chart.getZr().setCursorStyle("pointer")}}),this.chart.on("mouseout",i=>{const s=t(i);if(!s)return;const n=i.event?.target?.parent;if(s.drawing.id!==this.selectedDrawingId){if(e=setTimeout(()=>{if(n){if(this.selectedDrawingId===s.drawing.id)return;n.children().forEach(o=>{o.name&&o.name.startsWith("point")&&o.attr("style",{opacity:0})})}},50),s.targetName==="line")this.events.emit("drawing:mouseout",{id:s.drawing.id});else if(s.targetName?.startsWith("point")){const o=s.targetName==="point-start"?0:1;this.events.emit("drawing:point:mouseout",{id:s.drawing.id,pointIndex:o})}this.chart.getZr().setCursorStyle("default")}}),this.chart.on("mousedown",i=>{const s=t(i);if(!s)return;const n=i.event?.event||i.event,o=n?.offsetX,r=n?.offsetY;if(s.targetName==="line")this.events.emit("drawing:mousedown",{id:s.drawing.id,x:o,y:r});else if(s.targetName?.startsWith("point")){const p=s.targetName==="point-start"?0:1;this.events.emit("drawing:point:mousedown",{id:s.drawing.id,pointIndex:p,x:o,y:r})}}),this.chart.on("click",i=>{const s=t(i);if(s){if(this.selectedDrawingId!==s.drawing.id&&(this.selectedDrawingId=s.drawing.id,this.events.emit("drawing:selected",{id:s.drawing.id}),this.render()),s.targetName==="line")this.events.emit("drawing:click",{id:s.drawing.id});else if(s.targetName?.startsWith("point")){const n=s.targetName==="point-start"?0:1;this.events.emit("drawing:point:click",{id:s.drawing.id,pointIndex:n})}}}),this.chart.getZr().on("click",i=>{i.target||this.selectedDrawingId&&(this.events.emit("drawing:deselected",{id:this.selectedDrawingId}),this.selectedDrawingId=null,this.render())})}getChart(){return this.chart}getMarketData(){return this.marketData}getTimeToIndex(){return this.timeToIndex}getOptions(){return this.options}disableTools(){this.pluginManager.deactivatePlugin()}registerPlugin(e){this.pluginManager.register(e)}addDrawing(e){this.drawings.push(e),this.render()}removeDrawing(e){const t=this.drawings.findIndex(i=>i.id===e);if(t!==-1){const i=this.drawings[t];this.drawings.splice(t,1),this.events.emit("drawing:deleted",{id:i.id}),this.render()}}getDrawing(e){return this.drawings.find(t=>t.id===e)}updateDrawing(e){const t=this.drawings.findIndex(i=>i.id===e.id);t!==-1&&(this.drawings[t]=e,this.render())}lockChart(){if(this.isLocked)return;this.isLocked=!0;const e=this.chart.getOption();this.chart.setOption({dataZoom:e.dataZoom.map(t=>({...t,disabled:!0})),tooltip:{show:!1}})}unlockChart(){if(!this.isLocked)return;this.isLocked=!1;const e=this.chart.getOption();(this.options.dataZoom||{}).visible,e.dataZoom&&this.chart.setOption({dataZoom:e.dataZoom.map(t=>({...t,disabled:!1})),tooltip:{show:!0}})}setZoom(e,t){this.chart.dispatchAction({type:"dataZoom",start:e,end:t})}setMarketData(e){this.marketData=e,this.rebuildTimeIndex(),this.render()}updateData(e){if(e.length===0)return;const t=new Map;this.marketData.forEach(d=>{t.set(d.time,d)}),e.forEach(d=>{t.has(d.time),t.set(d.time,d)}),this.marketData=Array.from(t.values()).sort((d,x)=>d.time-x.time),this.rebuildTimeIndex();const i=this.dataIndexOffset,s=this.marketData.map(d=>[d.open,d.close,d.low,d.high]),n={value:[NaN,NaN,NaN,NaN],itemStyle:{opacity:0}},o=[...Array(i).fill(n),...s,...Array(i).fill(n)],r=[...Array(i).fill(""),...this.marketData.map(d=>new Date(d.time).toLocaleString()),...Array(i).fill("")],p=this.chart.getOption(),u=ut.calculate(this.chart.getHeight(),this.indicators,this.options,this.isMainCollapsed,this.maximizedPaneId),v=[...Array(i).fill(null),...this.marketData,...Array(i).fill(null)],f=q.buildIndicatorSeries(this.indicators,this.timeToIndex,u.paneLayout,r.length,i,v),m={xAxis:p.xAxis.map((d,x)=>({data:r})),series:[{data:o},...f.map(d=>({data:d.data}))]};this.chart.setOption(m,{notMerge:!1})}addIndicator(e,t,i={isOverlay:!1}){const s=i.isOverlay??!1;let n=0;if(!s){let r=0;this.indicators.forEach(p=>{p.paneIndex>r&&(r=p.paneIndex)}),n=r+1}const o=new mt(e,t,n,{height:i.height,collapsed:!1,titleColor:i.titleColor,controls:i.controls});return this.indicators.set(e,o),this.render(),o}setIndicator(e,t,i=!1){this.addIndicator(e,{[e]:t},{isOverlay:i})}removeIndicator(e){this.indicators.delete(e),this.render()}toggleIndicator(e,t="collapse"){if(t==="fullscreen"){document.fullscreenElement?document.exitFullscreen():this.rootContainer.requestFullscreen();return}if(t==="maximize"){this.maximizedPaneId===e?this.maximizedPaneId=null:this.maximizedPaneId=e,this.render();return}if(e==="main"){this.isMainCollapsed=!this.isMainCollapsed,this.render();return}const i=this.indicators.get(e);i&&(i.toggleCollapse(),this.render())}resize(){this.chart.resize()}destroy(){window.removeEventListener("resize",this.resize.bind(this)),document.removeEventListener("fullscreenchange",this.onFullscreenChange),document.removeEventListener("keydown",this.onKeyDown),this.pluginManager.deactivatePlugin(),this.pluginManager.destroy(),this.chart.dispose()}rebuildTimeIndex(){this.timeToIndex.clear(),this.marketData.forEach((i,s)=>{this.timeToIndex.set(i.time,s)});const e=this.marketData.length,t=Math.ceil(e*this.padding);this.dataIndexOffset=t}render(){if(this.marketData.length===0)return;let e=null;try{const y=this.chart.getOption();if(y&&y.dataZoom&&y.dataZoom.length>0){const c=y.dataZoom.find(l=>l.type==="slider"||l.type==="inside");c&&(e={start:c.start,end:c.end})}}catch{}const t=this.options.databox?.position,i=this.leftSidebar.style.display,s=this.rightSidebar.style.display,n=t==="left"?"block":"none",o=t==="right"?"block":"none";(i!==n||s!==o)&&(this.leftSidebar.style.display=n,this.rightSidebar.style.display=o,this.chart.resize());const r=this.dataIndexOffset,p=[...Array(r).fill(""),...this.marketData.map(y=>new Date(y.time).toLocaleString()),...Array(r).fill("")],u=ut.calculate(this.chart.getHeight(),this.indicators,this.options,this.isMainCollapsed,this.maximizedPaneId);e&&u.dataZoom&&u.dataZoom.forEach(y=>{y.start=e.start,y.end=e.end}),u.xAxis.forEach(y=>{y.data=p,y.boundaryGap=!1});const v=q.buildCandlestickSeries(this.marketData,this.options),f={value:[NaN,NaN,NaN,NaN],itemStyle:{opacity:0}};v.data=[...Array(r).fill(f),...v.data,...Array(r).fill(f)];const m=[...Array(r).fill(null),...this.marketData,...Array(r).fill(null)],d=q.buildIndicatorSeries(this.indicators,this.timeToIndex,u.paneLayout,p.length,r,m),x=vt.build(u,this.options,this.toggleIndicator.bind(this),this.isMainCollapsed,this.maximizedPaneId),S=new Map;this.drawings.forEach(y=>{const c=y.paneIndex||0;S.has(c)||S.set(c,[]),S.get(c).push(y)});const I=[];S.forEach((y,c)=>{I.push({type:"custom",name:`drawings-pane-${c}`,xAxisIndex:c,yAxisIndex:c,clip:!0,renderItem:(l,b)=>{const h=y[l.dataIndex];if(!h)return;const C=h.points[0],T=h.points[1];if(!C||!T)return;const g=b.coord([C.timeIndex,C.value]),w=b.coord([T.timeIndex,T.value]),z=h.id===this.selectedDrawingId;if(h.type==="line")return{type:"group",children:[{type:"line",name:"line",shape:{x1:g[0],y1:g[1],x2:w[0],y2:w[1]},style:{stroke:h.style?.color||"#3b82f6",lineWidth:h.style?.lineWidth||2}},{type:"circle",name:"point-start",shape:{cx:g[0],cy:g[1],r:4},style:{fill:"#fff",stroke:h.style?.color||"#3b82f6",lineWidth:1,opacity:z?1:0}},{type:"circle",name:"point-end",shape:{cx:w[0],cy:w[1],r:4},style:{fill:"#fff",stroke:h.style?.color||"#3b82f6",lineWidth:1,opacity:z?1:0}}]};if(h.type==="fibonacci"){const O=g[0],W=g[1],P=w[0],M=w[1],Z=Math.min(O,P),N=Math.max(O,P),A=N-Z,j=M-W,H=[0,.236,.382,.5,.618,.786,1],R=["#787b86","#f44336","#ff9800","#4caf50","#2196f3","#00bcd4","#787b86"],K=[];K.push({type:"line",name:"line",shape:{x1:O,y1:W,x2:P,y2:M},style:{stroke:"#999",lineWidth:1,lineDash:[4,4]}}),K.push({type:"circle",name:"point-start",shape:{cx:O,cy:W,r:4},style:{fill:"#fff",stroke:h.style?.color||"#3b82f6",lineWidth:1,opacity:z?1:0},z:100}),K.push({type:"circle",name:"point-end",shape:{cx:P,cy:M,r:4},style:{fill:"#fff",stroke:h.style?.color||"#3b82f6",lineWidth:1,opacity:z?1:0},z:100}),H.forEach((Q,Y)=>{const X=M-j*Q,et=R[Y%R.length];K.push({type:"line",name:"fib-line",shape:{x1:Z,y1:X,x2:N,y2:X},style:{stroke:et,lineWidth:1},silent:!0});const rt=h.points[0].value,it=h.points[1].value,lt=it-rt,ht=it-lt*Q;if(K.push({type:"text",style:{text:`${Q} (${ht.toFixed(2)})`,x:Z+5,y:X-10,fill:et,fontSize:10},silent:!0}),Y<H.length-1){const dt=H[Y+1],st=M-j*dt,ct=Math.abs(st-X),pt=Math.min(X,st);K.push({type:"rect",shape:{x:Z,y:pt,width:A,height:ct},style:{fill:R[(Y+1)%R.length],opacity:.1},silent:!0})}});const gt=[],at=[];return H.forEach((Q,Y)=>{const X=M-j*Q,et=R[Y%R.length];at.push({type:"line",shape:{x1:Z,y1:X,x2:N,y2:X},style:{stroke:et,lineWidth:1},silent:!0});const rt=h.points[0].value,it=h.points[1].value,lt=it-rt,ht=it-lt*Q;if(at.push({type:"text",style:{text:`${Q} (${ht.toFixed(2)})`,x:Z+5,y:X-10,fill:et,fontSize:10},silent:!0}),Y<H.length-1){const dt=H[Y+1],st=M-j*dt,ct=Math.abs(st-X),pt=Math.min(X,st);gt.push({type:"rect",name:"line",shape:{x:Z,y:pt,width:A,height:ct},style:{fill:R[(Y+1)%R.length],opacity:.1}})}}),{type:"group",children:[...gt,...at,{type:"line",name:"line",shape:{x1:O,y1:W,x2:P,y2:M},style:{stroke:"#999",lineWidth:1,lineDash:[4,4]}},{type:"circle",name:"point-start",shape:{cx:O,cy:W,r:4},style:{fill:"#fff",stroke:h.style?.color||"#3b82f6",lineWidth:1,opacity:z?1:0},z:100},{type:"circle",name:"point-end",shape:{cx:P,cy:M,r:4},style:{fill:"#fff",stroke:h.style?.color||"#3b82f6",lineWidth:1,opacity:z?1:0},z:100}]}}},data:y.map(l=>[l.points[0].timeIndex,l.points[0].value,l.points[1].timeIndex,l.points[1].value]),z:100,silent:!1})});const L=y=>{const c=wt.format(y,this.options),l=this.options.databox?.position;return l==="left"?(this.leftSidebar.innerHTML=c,""):l==="right"?(this.rightSidebar.innerHTML=c,""):this.options.databox?`<div style="min-width: 200px;">${c}</div>`:""},D={backgroundColor:this.options.backgroundColor,animation:!1,legend:{show:!1},tooltip:{show:!0,showContent:!!this.options.databox,trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#475569"}},backgroundColor:"rgba(30, 41, 59, 0.9)",borderWidth:1,borderColor:"#334155",padding:10,textStyle:{color:"#fff",fontFamily:this.options.fontFamily||"sans-serif"},formatter:L,extraCssText:t!=="floating"&&t!==void 0?"display: none !important;":void 0,position:(y,c,l,b,h)=>{if(this.options.databox?.position==="floating"){const C={top:10};return C[["left","right"][+(y[0]<h.viewSize[0]/2)]]=30,C}return null}},axisPointer:{link:{xAxisIndex:"all"},label:{backgroundColor:"#475569"}},graphic:x,grid:u.grid,xAxis:u.xAxis,yAxis:u.yAxis,dataZoom:u.dataZoom,series:[v,...d,...I]};this.chart.setOption(D,!0)}}var Gt=Object.defineProperty,$t=(a,e,t)=>e in a?Gt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,tt=(a,e,t)=>($t(a,typeof e!="symbol"?e+"":e,t),t);class nt{constructor(e){tt(this,"id"),tt(this,"name"),tt(this,"icon"),tt(this,"context"),tt(this,"eventListeners",[]),this.id=e.id,this.name=e.name,this.icon=e.icon}init(e){this.context=e,this.onInit()}onInit(){}activate(){this.onActivate(),this.context.events.emit("plugin:activated",this.id)}onActivate(){}deactivate(){this.onDeactivate(),this.context.events.emit("plugin:deactivated",this.id)}onDeactivate(){}destroy(){this.removeAllListeners(),this.onDestroy()}onDestroy(){}on(e,t){this.context.events.on(e,t),this.eventListeners.push({event:e,handler:t})}off(e,t){this.context.events.off(e,t),this.eventListeners=this.eventListeners.filter(i=>i.event!==e||i.handler!==t)}removeAllListeners(){this.eventListeners.forEach(({event:e,handler:t})=>{this.context.events.off(e,t)}),this.eventListeners=[]}get chart(){return this.context.getChart()}get marketData(){return this.context.getMarketData()}}var Nt=Object.defineProperty,Ft=(a,e,t)=>e in a?Nt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,G=(a,e,t)=>(Ft(a,typeof e!="symbol"?e+"":e,t),t);class Ot extends nt{constructor(e){super({id:"measure",name:e?.name||"Measure",icon:e?.icon||'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M160-240q-33 0-56.5-23.5T80-320v-320q0-33 23.5-56.5T160-720h640q33 0 56.5 23.5T880-640v320q0 33-23.5 56.5T800-240H160Zm0-80h640v-320H680v160h-80v-160h-80v160h-80v-160h-80v160h-80v-160H160v320Zm120-160h80-80Zm160 0h80-80Zm160 0h80-80Zm-120 0Z"/></svg>'}),G(this,"zr"),G(this,"state","idle"),G(this,"startPoint",null),G(this,"endPoint",null),G(this,"group",null),G(this,"rect",null),G(this,"labelRect",null),G(this,"labelText",null),G(this,"lineV",null),G(this,"lineH",null),G(this,"arrowStart",null),G(this,"arrowEnd",null),G(this,"onMouseDown",()=>{this.state==="finished"&&this.removeGraphic()}),G(this,"onChartInteraction",()=>{this.group&&this.removeGraphic()}),G(this,"onClick",t=>{this.state==="idle"?(this.state="drawing",this.startPoint=[t.offsetX,t.offsetY],this.endPoint=[t.offsetX,t.offsetY],this.initGraphic(),this.updateGraphic()):this.state==="drawing"&&(this.state="finished",this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic(),this.context.disableTools(),this.enableClearListeners())}),G(this,"clearHandlers",{}),G(this,"onMouseMove",t=>{this.state==="drawing"&&(this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic())})}onInit(){this.zr=this.chart.getZr()}onActivate(){this.state="idle",this.chart.getZr().setCursorStyle("crosshair"),this.zr.on("click",this.onClick),this.zr.on("mousemove",this.onMouseMove)}onDeactivate(){this.state="idle",this.chart.getZr().setCursorStyle("default"),this.zr.off("click",this.onClick),this.zr.off("mousemove",this.onMouseMove),this.disableClearListeners(),this.state==="drawing"&&this.removeGraphic()}onDestroy(){this.removeGraphic()}enableClearListeners(){const e=()=>{this.removeGraphic()};setTimeout(()=>{this.zr.on("click",e)},10),this.zr.on("mousedown",this.onMouseDown),this.context.events.on("chart:dataZoom",this.onChartInteraction),this.clearHandlers={click:e,mousedown:this.onMouseDown,dataZoom:this.onChartInteraction}}disableClearListeners(){this.clearHandlers.click&&this.zr.off("click",this.clearHandlers.click),this.clearHandlers.mousedown&&this.zr.off("mousedown",this.clearHandlers.mousedown),this.clearHandlers.dataZoom&&this.context.events.off("chart:dataZoom",this.clearHandlers.dataZoom),this.clearHandlers={}}initGraphic(){this.group||(this.group=new E.graphic.Group,this.rect=new E.graphic.Rect({shape:{x:0,y:0,width:0,height:0},style:{fill:"rgba(0,0,0,0)",stroke:"transparent",lineWidth:0},z:100}),this.lineV=new E.graphic.Line({shape:{x1:0,y1:0,x2:0,y2:0},style:{stroke:"#fff",lineWidth:1,lineDash:[4,4]},z:101}),this.lineH=new E.graphic.Line({shape:{x1:0,y1:0,x2:0,y2:0},style:{stroke:"#fff",lineWidth:1,lineDash:[4,4]},z:101}),this.arrowStart=new E.graphic.Polygon({shape:{points:[[0,0],[-5,10],[5,10]]},style:{fill:"#fff"},z:102}),this.arrowEnd=new E.graphic.Polygon({shape:{points:[[0,0],[-5,-10],[5,-10]]},style:{fill:"#fff"},z:102}),this.labelRect=new E.graphic.Rect({shape:{x:0,y:0,width:0,height:0,r:4},style:{fill:"transparent",stroke:"transparent",lineWidth:0,shadowBlur:5,shadowColor:"rgba(0,0,0,0.3)"},z:102}),this.labelText=new E.graphic.Text({style:{x:0,y:0,text:"",fill:"#fff",font:"12px sans-serif",align:"center",verticalAlign:"middle"},z:103}),this.group.add(this.rect),this.group.add(this.lineV),this.group.add(this.lineH),this.group.add(this.arrowStart),this.group.add(this.arrowEnd),this.group.add(this.labelRect),this.group.add(this.labelText),this.zr.add(this.group))}removeGraphic(){this.group&&(this.zr.remove(this.group),this.group=null,this.disableClearListeners())}updateGraphic(){if(!this.startPoint||!this.endPoint||!this.group)return;const[e,t]=this.startPoint,[i,s]=this.endPoint,n=this.context.coordinateConversion.pixelToData({x:e,y:t}),o=this.context.coordinateConversion.pixelToData({x:i,y:s});if(!n||!o)return;const r=Math.round(n.timeIndex),p=Math.round(o.timeIndex),u=n.value,v=o.value,f=p-r,m=v-u,d=m/u*100,x=m>=0,S=x?"rgba(33, 150, 243, 0.2)":"rgba(236, 0, 0, 0.2)",I=x?"#2196F3":"#ec0000";this.rect.setShape({x:Math.min(e,i),y:Math.min(t,s),width:Math.abs(i-e),height:Math.abs(s-t)}),this.rect.setStyle({fill:S});const L=(e+i)/2,D=(t+s)/2;this.lineV.setShape({x1:L,y1:t,x2:L,y2:s}),this.lineV.setStyle({stroke:I}),this.lineH.setShape({x1:e,y1:D,x2:i,y2:D}),this.lineH.setStyle({stroke:I});const y=Math.min(t,s),c=Math.max(t,s);this.arrowStart.setStyle({fill:"none"}),this.arrowEnd.setStyle({fill:"none"}),x?(this.arrowStart.setShape({points:[[L,y],[L-4,y+6],[L+4,y+6]]}),this.arrowStart.setStyle({fill:I})):(this.arrowEnd.setShape({points:[[L,c],[L-4,c-6],[L+4,c-6]]}),this.arrowEnd.setStyle({fill:I}));const l=[`${m.toFixed(2)} (${d.toFixed(2)}%)`,`${f} bars, ${(f*0).toFixed(0)}d`].join(`
`),b=140,h=40,C=Math.max(t,s),T=Math.min(t,s);let g=(e+i)/2-b/2,w=C+10;const z=this.chart.getHeight();w+h>z&&(w=T-h-10),this.labelRect.setShape({x:g,y:w,width:b,height:h}),this.labelRect.setStyle({fill:"#1e293b",stroke:I,lineWidth:1}),this.labelText.setStyle({x:g+b/2,y:w+h/2,text:l,fill:"#fff"})}}var Wt=Object.defineProperty,Ht=(a,e,t)=>e in a?Wt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,F=(a,e,t)=>(Ht(a,typeof e!="symbol"?e+"":e,t),t);class jt extends nt{constructor(e){super({id:"trend-line",name:e?.name||"Trend Line",icon:e?.icon||'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="2" y1="22" x2="22" y2="2" /></svg>'}),F(this,"zr"),F(this,"state","idle"),F(this,"startPoint",null),F(this,"endPoint",null),F(this,"group",null),F(this,"line",null),F(this,"startCircle",null),F(this,"endCircle",null),F(this,"onMouseDown",()=>{}),F(this,"onChartInteraction",()=>{}),F(this,"onClick",t=>{if(this.state==="idle")this.state="drawing",this.startPoint=[t.offsetX,t.offsetY],this.endPoint=[t.offsetX,t.offsetY],this.initGraphic(),this.updateGraphic();else if(this.state==="drawing"){if(this.state="finished",this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic(),this.startPoint&&this.endPoint){const i=this.context.coordinateConversion.pixelToData({x:this.startPoint[0],y:this.startPoint[1]}),s=this.context.coordinateConversion.pixelToData({x:this.endPoint[0],y:this.endPoint[1]});if(i&&s){const n=i.paneIndex||0;this.context.addDrawing({id:`line-${Date.now()}`,type:"line",points:[i,s],paneIndex:n,style:{color:"#3b82f6",lineWidth:2}})}}this.removeGraphic(),this.context.disableTools()}}),F(this,"clearHandlers",{}),F(this,"onMouseMove",t=>{this.state==="drawing"&&(this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic())})}onInit(){this.zr=this.chart.getZr()}onActivate(){this.state="idle",this.chart.getZr().setCursorStyle("crosshair"),this.zr.on("click",this.onClick),this.zr.on("mousemove",this.onMouseMove)}onDeactivate(){this.state="idle",this.chart.getZr().setCursorStyle("default"),this.zr.off("click",this.onClick),this.zr.off("mousemove",this.onMouseMove),this.disableClearListeners(),this.state==="drawing"&&this.removeGraphic()}onDestroy(){this.removeGraphic()}saveDataCoordinates(){}updateGraphicFromData(){}enableClearListeners(){}disableClearListeners(){}initGraphic(){this.group||(this.group=new E.graphic.Group,this.line=new E.graphic.Line({shape:{x1:0,y1:0,x2:0,y2:0},style:{stroke:"#3b82f6",lineWidth:2},z:100}),this.startCircle=new E.graphic.Circle({shape:{cx:0,cy:0,r:4},style:{fill:"#fff",stroke:"#3b82f6",lineWidth:1},z:101}),this.endCircle=new E.graphic.Circle({shape:{cx:0,cy:0,r:4},style:{fill:"#fff",stroke:"#3b82f6",lineWidth:1},z:101}),this.group.add(this.line),this.group.add(this.startCircle),this.group.add(this.endCircle),this.zr.add(this.group))}removeGraphic(){this.group&&(this.zr.remove(this.group),this.group=null,this.disableClearListeners())}updateGraphic(){if(!this.startPoint||!this.endPoint||!this.group)return;const[e,t]=this.startPoint,[i,s]=this.endPoint;this.line.setShape({x1:e,y1:t,x2:i,y2:s}),this.startCircle.setShape({cx:e,cy:t}),this.endCircle.setShape({cx:i,cy:s})}}var Rt=Object.defineProperty,Xt=(a,e,t)=>e in a?Rt(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,V=(a,e,t)=>(Xt(a,typeof e!="symbol"?e+"":e,t),t);class Bt extends nt{constructor(e={}){super({id:"fibonacci-tool",name:e.name||"Fibonacci Retracement",icon:e.icon||'<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M120-80v-80h720v80H120Zm0-240v-80h720v80H120Zm0-240v-80h720v80H120Zm0-240v-80h720v80H120Z"/></svg>'}),V(this,"startPoint",null),V(this,"endPoint",null),V(this,"state","idle"),V(this,"graphicGroup",null),V(this,"levels",[0,.236,.382,.5,.618,.786,1]),V(this,"colors",["#787b86","#f44336","#ff9800","#4caf50","#2196f3","#00bcd4","#787b86"]),V(this,"onClick",t=>{this.state==="idle"?(this.state="drawing",this.startPoint=[t.offsetX,t.offsetY],this.endPoint=[t.offsetX,t.offsetY],this.initGraphic(),this.updateGraphic()):this.state==="drawing"&&(this.state="finished",this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic(),this.saveDrawing(),this.removeGraphic(),this.context.disableTools())}),V(this,"onMouseMove",t=>{this.state==="drawing"&&(this.endPoint=[t.offsetX,t.offsetY],this.updateGraphic())})}onActivate(){this.state="idle",this.startPoint=null,this.endPoint=null,this.context.getChart().getZr().setCursorStyle("crosshair"),this.bindEvents()}onDeactivate(){this.state="idle",this.startPoint=null,this.endPoint=null,this.removeGraphic(),this.unbindEvents(),this.context.getChart().getZr().setCursorStyle("default")}bindEvents(){const e=this.context.getChart().getZr();e.on("click",this.onClick),e.on("mousemove",this.onMouseMove)}unbindEvents(){const e=this.context.getChart().getZr();e.off("click",this.onClick),e.off("mousemove",this.onMouseMove)}initGraphic(){this.graphicGroup=new E.graphic.Group,this.context.getChart().getZr().add(this.graphicGroup)}removeGraphic(){this.graphicGroup&&(this.context.getChart().getZr().remove(this.graphicGroup),this.graphicGroup=null)}updateGraphic(){if(!this.graphicGroup||!this.startPoint||!this.endPoint)return;this.graphicGroup.removeAll();const e=this.startPoint[0],t=this.startPoint[1],i=this.endPoint[0],s=this.endPoint[1],n=new E.graphic.Line({shape:{x1:e,y1:t,x2:i,y2:s},style:{stroke:"#999",lineWidth:1,lineDash:[4,4]},silent:!0});this.graphicGroup.add(n);const o=Math.min(e,i),r=Math.max(e,i),p=r-o,u=s-t;this.levels.forEach((v,f)=>{const m=s-u*v,d=this.colors[f%this.colors.length],x=new E.graphic.Line({shape:{x1:o,y1:m,x2:r,y2:m},style:{stroke:d,lineWidth:1},silent:!0});if(this.graphicGroup.add(x),f<this.levels.length-1){const S=this.levels[f+1],I=s-u*S,L=Math.abs(I-m),D=Math.min(m,I),y=new E.graphic.Rect({shape:{x:o,y:D,width:p,height:L},style:{fill:this.colors[(f+1)%this.colors.length],opacity:.1},silent:!0});this.graphicGroup.add(y)}})}saveDrawing(){if(!this.startPoint||!this.endPoint)return;const e=this.context.coordinateConversion.pixelToData({x:this.startPoint[0],y:this.startPoint[1]}),t=this.context.coordinateConversion.pixelToData({x:this.endPoint[0],y:this.endPoint[1]});if(e&&t){const i=e.paneIndex||0;this.context.addDrawing({id:`fib-${Date.now()}`,type:"fibonacci",points:[e,t],paneIndex:i,style:{color:"#3b82f6",lineWidth:1}})}}}B.AbstractPlugin=nt,B.FibonacciTool=Bt,B.LineTool=jt,B.MeasureTool=Ot,B.QFChart=Zt});
